<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expiring Soon</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="./css/new-navigation.css">
    <link rel="stylesheet" href="./css/expiring-soon.css">
    <script src="./js/config.js"></script>
</head>

<body>
    <nav class="nav-bar">
        <div class="nav-container">
            <a href="index.html" class="brand">
                <span class="brand-text">Fertilizer<span>Manager</span></span>
            </a>
            <div class="nav-links">
                <a href="afterlogindashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="total-stock.html" class="nav-link">
                    <i class="fas fa-boxes"></i> TotalStock
                </a>
                <a href="low-stock-alerts.html" class="nav-link">
                    <i class="fas fa-exclamation-triangle"></i> LowStock
                </a>
                <a href="expiring-soon.html" class="nav-link active">
                    <i class="fas fa-clock"></i> ExpiringSoon
                </a>
                <a href="suppliers.html" class="nav-link">
                    <i class="fas fa-truck"></i> Suppliers
                </a>
                <a href="order-history.html" class="nav-link">
                    <i class="fas fa-history"></i> OrderHistory
                </a>
                <a href="customers.html" class="nav-link">
                    <i class="fas fa-users"></i> Customers
                </a>
                <a href="sales.html" class="nav-link">
                    <i class="fas fa-shopping-cart"></i> Sales
                </a>
                <a href="credit.html" class="nav-link">
                    <i class="fas fa-credit-card"></i> Credit
                </a>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="header-section">
            <h1>Expiring Soon</h1>
            <div class="header-actions">
                <button class="back-button" onclick="window.location.href='afterlogindashboard.html'">
                    <i class="fas fa-arrow-left"></i>
                    Back to Dashboard
                </button>
                <button class="refresh-button" onclick="fetchExpiringSoonProducts()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh List
                </button>
            </div>
        </div>

        <div id="alerts-container">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                Loading products...
            </div>
        </div>
    </div>

<script>
    // Page load + authentication check
    document.addEventListener('DOMContentLoaded', () => {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            window.location.href = 'loginpage.html';
            return;
        }

        // Safe check for API_BASE_URL
        if (typeof API_BASE_URL === "undefined") {
            console.error("API_BASE_URL is not defined. Check config.js load order.");
            return;
        }

        fetchExpiringSoonProducts();
    });

    // Fetch expiring soon products
    async function fetchExpiringSoonProducts() {
        const alertsContainer = document.getElementById('alerts-container');
        if (!alertsContainer) return; // safety check

        alertsContainer.innerHTML = `
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading products...
            </div>
        `;

        const userId = localStorage.getItem('userId');
        if (!userId) {
            window.location.href = 'loginpage.html';
            return;
        }

        try {
            // GET request â€” cleaner headers
            const response = await fetch(`${API_BASE_URL}/stock/expiring-soon?userId=${userId}`);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || 'Failed to fetch expiring products');
            }

            const data = await response.json();
            console.log('Received data:', data);
            renderExpiringSoonProducts(data);

        } catch (error) {
            console.error('Error fetching expiring soon products:', error);

            alertsContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    ${error.message || 'An error occurred while fetching products. Please try again.'}
                </div>
            `;
        }
    }

    // Render expiring soon products
    function renderExpiringSoonProducts(products) {
        const alertsContainer = document.getElementById('alerts-container');
        if (!alertsContainer) return;

        alertsContainer.innerHTML = '';

        if (!Array.isArray(products) || products.length === 0) {
            alertsContainer.innerHTML = `
                <div class="alert normal">
                    <div class="alert-content">
                        <h3><i class="fas fa-check-circle"></i> No products expiring soon!</h3>
                        <p class="alert-message">All products are within their expiry dates.</p>
                    </div>
                </div>
            `;
            return;
        }

        products.forEach(product => {
            if (!product || typeof product !== 'object') return;

            const days = product.days_until_expiry ?? 9999;
            let severityClass = "normal";
            let severityIcon = "info-circle";
            let message = `Expires in ${days} days`;

            if (days <= 0) {
                severityClass = "critical";
                severityIcon = "exclamation-circle";
                message = "Product has expired!";
            } else if (days <= 7) {
                severityClass = "critical";
                severityIcon = "exclamation-circle";
                message = `Expires in ${days} days`;
            } else if (days <= 30) {
                severityClass = "warning";
                severityIcon = "exclamation-triangle";
                message = `Expires in ${days} days`;
            }

            const expiryDateObj = new Date(product.expiry_date);
            const expiryDate = isNaN(expiryDateObj) ? "N/A" : expiryDateObj.toLocaleDateString();

            const alertDiv = document.createElement("div");
            alertDiv.className = `alert ${severityClass}`;

            alertDiv.innerHTML = `
                <div class="alert-content">
                    <h3>
                        <i class="fas fa-${severityIcon}"></i>
                        ${message}
                    </h3>
                    <div class="product-name-row">
                        <span class="label">Product Name:</span>
                        <span class="value">${product.product_name || 'Unknown Product'}</span>
                    </div>
                    <div class="alert-details">
                        <p><span>Category:</span> <span>${product.category || 'N/A'}</span></p>
                        <p><span>Supplier:</span> <span>${product.supplier_name || 'N/A'}</span></p>
                        <p><span>Quantity:</span> <span class="quantity">${product.quantity || 0} ${product.quantity_unit || ''}</span></p>
                        <p><span>Number of Items:</span> <span>${product.number_of_items || 0}</span></p>
                        <p><span>Expiry Date:</span> 
                            <span class="expiry-date ${severityClass}">
                                ${expiryDate}
                            </span>
                        </p>
                    </div>
                </div>
            `;

            alertsContainer.appendChild(alertDiv);
        });
    }

    // Inline styles injection (fine as is)
    const style = document.createElement('style');
    style.textContent = `
        .product-name-row { padding: 10px 0; margin: 10px 0; border-bottom: 1px solid #eee; }
        .product-name-row .label { font-weight: 500; color: #333; margin-right: 10px; }
        .product-name-row .value { font-weight: 600; color: #000; }
        .expiry-date.critical { color: #dc3545; font-weight: bold; }
        .expiry-date.warning { color: #ffc107; font-weight: bold; }
    `;
    document.head.appendChild(style);

</script>
</body>

</html>